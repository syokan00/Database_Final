# 更新ログ

## [2024-12] - 通知・ソーシャル機能の実装

### 追加された機能

#### 通知システム
- ✅ いいね、お気に入り、フォロー、コメント、メッセージの通知機能
- ✅ 通知の既読管理（個別・一括）
- ✅ 未読通知数のバッジ表示
- ✅ 通知クリックで適切なページへ自動遷移
- ✅ 新規登録ユーザーには通知を表示しない

#### フォロー機能
- ✅ ユーザー間のフォロー/フォロー解除機能
- ✅ フォロワー/フォロー中リストの表示
- ✅ プロフィールページにフォロワー数とフォロー中数を表示
- ✅ フォローリストページ（`FollowListPage`）の実装

#### 商品チャット機能
- ✅ 商品に関するメッセージング機能
- ✅ 売り手と買い手の両方の視点に対応
- ✅ メッセージ受信時に通知を自動生成
- ✅ 通知からチャットページへの遷移

#### ユーザープロフィール閲覧
- ✅ 他ユーザーのプロフィールを閲覧可能
- ✅ プロフィールページから直接フォロー/フォロー解除
- ✅ 他ユーザーの投稿とアイテムを閲覧可能
- ✅ プロフィールのローディング状態とエラーハンドリング

### UI/UX の改善

#### メニュー改善
- ✅ React Portal を使用して三つ点メニューを `document.body` にレンダリング
- ✅ メニューの位置を自動計算し、画面外にはみ出さないように調整
- ✅ クリックイベントの競合を解決し、メニューの安定性を向上

#### フォーム改善
- ✅ すべてのフォームフィールドに `id` と `name` 属性を追加
- ✅ `htmlFor` 属性を使用してラベルと入力フィールドを関連付け

#### Service Worker 改善
- ✅ サポートされていないプロトコル（chrome-extension など）のリクエストをスキップ
- ✅ 外部リソースのキャッシュをスキップ
- ✅ 常に有効な `Response` オブジェクトを返すように改善

### 国際化（i18n）

#### 追加された翻訳キー
- **notifications**: 通知関連のすべてのテキスト
- **follow**: フォロー関連のすべてのテキスト
- **chat**: チャット関連のすべてのテキスト
- **profile**: プロフィール閲覧関連のテキスト
- **common**: 共通のテキスト（`unfollow`, `moreOptions`）

### バグ修正

1. **通知システム**
   - 新規登録ユーザーが不要な通知を受信する問題を修正
   - 通知の生成ロジックを改善

2. **商品チャット**
   - 売り手が買い手のメッセージを確認できない問題を修正
   - バックエンドで自動的に買い手を特定する機能を追加

3. **プロフィール閲覧**
   - 他ユーザーのプロフィールが空白で表示される問題を修正
   - ローディング状態とエラーハンドリングを追加

4. **メニューUI**
   - 三つ点メニューが点滅し、クリックしにくい問題を修正
   - React Portal を使用し、イベント処理を最適化

5. **Service Worker**
   - サポートされていないプロトコルのリクエストでエラーが発生する問題を修正
   - プロトコルチェックとエラーハンドリングを追加

### データベース変更

#### 新規テーブル
- `notifications`: 通知情報を格納
- `item_messages`: 商品メッセージを格納

#### 既存テーブルの変更
- `follows`: 既存（変更なし）

### API エンドポイント

#### 新規エンドポイント
- `GET /notifications/` - 通知リスト取得
- `GET /notifications/unread/count` - 未読通知数取得
- `PUT /notifications/{id}/read` - 通知を既読にする
- `PUT /notifications/read-all` - すべての通知を既読にする
- `GET /users/{user_id}/followers` - フォロワーリスト取得
- `GET /users/{user_id}/following` - フォロー中リスト取得
- `GET /users/me/following` - 現在のユーザーのフォロー中IDリスト取得
- `POST /messages/items/{item_id}` - 商品メッセージ送信
- `GET /messages/items/{item_id}` - 商品メッセージ取得
- `GET /messages/items` - 商品会話リスト取得
- `GET /users/{user_id}/stats` - ユーザー統計取得

### フロントエンドコンポーネント

#### 新規コンポーネント
- `FollowListPage` - フォロワー/フォロー中リスト表示ページ

#### 更新されたコンポーネント
- `Navbar` - 通知ドロップダウン、通知カウント表示
- `ProfilePage` - 他ユーザープロフィール閲覧、フォロー機能統合
- `ChatPage` - 商品チャット機能
- `ItemMoreMenu` - React Portal 使用、位置自動調整

### ドキュメント更新

- ✅ 新規機能ドキュメント: `docs/features/notification-and-social-features.md`
- ✅ アプリケーション概要の更新: `docs/PM/app-overview.md`
- ✅ README の更新: `README.md`
- ✅ 更新ログの作成: `docs/CHANGELOG.md`

### 技術的改善

1. **React Portal の使用**: メニューの z-index と overflow の問題を解決
2. **イベント処理の最適化**: クリックイベントの競合を解決
3. **エラーハンドリングの強化**: すべての API 呼び出しにエラーハンドリングを追加
4. **ローディング状態の追加**: ユーザー体験を向上させるためのローディング状態を追加
5. **国際化の完全実装**: すべてのハードコードされたテキストを翻訳キーに置き換え

### パフォーマンス改善

1. **通知の自動更新**: 30秒ごとに通知を自動更新
2. **メッセージの効率的な取得**: 商品メッセージの取得ロジックを最適化
3. **プロフィール情報のキャッシュ**: ユーザー統計情報の取得を最適化

---

## 以前のバージョン

詳細は各機能の実装ドキュメントを参照してください。

