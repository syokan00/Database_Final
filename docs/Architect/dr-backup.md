# DR / バックアップ戦略

## 概要

本ドキュメントでは、システムの災害復旧（Disaster Recovery: DR）とバックアップ戦略を定義します。現在は開発・展示用途ですが、将来的な本番環境も考慮した設計とします。

## バックアップ戦略

### 1. データベース（PostgreSQL）バックアップ

#### バックアップ方式
- **フルバックアップ**: 1 日 1 回（深夜 2:00）
- **増分バックアップ**: 現在は実施せず（将来の拡張項目）
- **バックアップ形式**: SQL ダンプ（`pg_dump`）

#### バックアップスクリプト例
```bash
#!/bin/bash
# バックアップディレクトリ
BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/db_backup_$DATE.sql.gz"

# PostgreSQL バックアップ実行
pg_dump -h localhost -U dbuser -d dbname | gzip > $BACKUP_FILE

# 30 日より古いバックアップを削除
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +30 -delete
```

#### バックアップ保存場所
- **ローカル**: `/backup/postgresql/`（Docker ボリューム）
- **リモート**: 将来は S3 や Google Cloud Storage に自動アップロード

#### バックアップ保持期間
- **30 日間**: 1 ヶ月分のバックアップを保持
- **週次バックアップ**: 毎週日曜日のバックアップは 3 ヶ月間保持
- **月次バックアップ**: 毎月 1 日のバックアップは 1 年間保持

### 2. オブジェクトストレージ（MinIO）バックアップ

#### バックアップ方式
- **フルバックアップ**: 1 日 1 回（深夜 3:00）
- **バックアップ方法**: MinIO の `mc mirror` コマンドで別バケットにコピー

#### バックアップスクリプト例
```bash
#!/bin/bash
# MinIO バックアップ
SOURCE_BUCKET="uploads"
BACKUP_BUCKET="uploads-backup"

# MinIO クライアントでバックアップ実行
mc mirror --overwrite minio/$SOURCE_BUCKET minio/$BACKUP_BUCKET

# 30 日より古いオブジェクトを削除（ライフサイクルポリシー）
mc ilm rule add minio/$BACKUP_BUCKET --expiry-days 30
```

#### バックアップ保存場所
- **同一 MinIO インスタンス**: 別バケット（`uploads-backup`）
- **将来**: 別リージョンの MinIO インスタンスまたは S3 互換ストレージ

#### バックアップ保持期間
- **30 日間**: データベースと同様に 30 日間保持

### 3. 設定ファイル・コードバックアップ

#### バックアップ対象
- **環境変数ファイル**: `.env.example`（機密情報は除外）
- **Docker Compose 設定**: `docker-compose.yml`
- **アプリケーションコード**: Git リポジトリ（GitHub）

#### バックアップ方式
- **Git**: GitHub リポジトリに自動バックアップ
- **設定ファイル**: Git リポジトリにコミット（機密情報は除外）

## 災害復旧（DR）戦略

### 復旧シナリオ別の手順

#### シナリオ 1: データベース障害

**症状**: PostgreSQL が起動しない、データが破損

**復旧手順**:
1. 最新のバックアップファイルを確認
2. PostgreSQL コンテナを停止
3. データディレクトリをクリーンアップ（必要に応じて）
4. バックアップからリストア:
   ```bash
   gunzip < /backup/postgresql/db_backup_YYYYMMDD_HHMMSS.sql.gz | psql -h localhost -U dbuser -d dbname
   ```
5. PostgreSQL コンテナを再起動
6. データ整合性を確認
7. アプリケーションを再起動

**目標復旧時間**: 2 ～ 4 時間

#### シナリオ 2: オブジェクトストレージ障害

**症状**: MinIO が起動しない、ファイルが消失

**復旧手順**:
1. 最新のバックアップバケットを確認
2. MinIO コンテナを停止
3. MinIO データディレクトリをクリーンアップ（必要に応じて）
4. バックアップからリストア:
   ```bash
   mc mirror --overwrite minio/uploads-backup minio/uploads
   ```
5. MinIO コンテナを再起動
6. ファイルアクセステスト
7. アプリケーションを再起動

**目標復旧時間**: 1 ～ 2 時間

#### シナリオ 3: バックエンドサーバー障害

**症状**: FastAPI アプリケーションが起動しない、サーバーがダウン

**復旧手順**:
1. サーバーの状態を確認（CPU、メモリ、ディスク）
2. Docker コンテナのログを確認
3. 必要に応じて Docker コンテナを再起動:
   ```bash
   docker-compose down
   docker-compose up -d
   ```
4. アプリケーションのヘルスチェック
5. API エンドポイントの動作確認

**目標復旧時間**: 30 分 ～ 1 時間

#### シナリオ 4: フロントエンド障害（GitHub Pages）

**症状**: GitHub Pages が表示されない、ビルドエラー

**復旧手順**:
1. GitHub Actions のビルドログを確認
2. ローカルでビルドテスト:
   ```bash
   cd frontend
   npm run build
   ```
3. エラーを修正してコミット・プッシュ
4. GitHub Actions が自動的に再デプロイ
5. デプロイ完了を確認

**目標復旧時間**: 数分 ～ 30 分

#### シナリオ 5: 完全なシステム障害

**症状**: 全コンポーネントがダウン、データセンター障害

**復旧手順**:
1. 障害範囲の確認（データベース、ストレージ、アプリケーション）
2. バックアップの整合性確認
3. 新しい環境の構築（必要に応じて）:
   - Docker 環境のセットアップ
   - データベースのリストア
   - オブジェクトストレージのリストア
   - アプリケーションのデプロイ
4. 動作確認とテスト
5. サービス再開

**目標復旧時間**: 4 ～ 8 時間

### 復旧テスト計画

#### テスト頻度
- **四半期ごと**: 3 ヶ月に 1 回の災害復旧訓練
- **テスト内容**: 各シナリオの復旧手順を実際に実行

#### テスト手順
1. テスト環境でバックアップを取得
2. 意図的に障害を発生させる（データベース停止など）
3. 復旧手順を実行
4. 復旧時間とデータ整合性を記録
5. 改善点を特定して手順書を更新

## 将来の本番環境での改善案

### 1. 自動バックアップの強化
- **リアルタイムレプリケーション**: PostgreSQL のマスター・スレーブ構成
- **継続的バックアップ**: トランザクションログのリアルタイムバックアップ
- **マルチリージョンバックアップ**: 地理的に分散したバックアップ保存

### 2. 自動フェイルオーバー
- **データベース**: マスター障害時に自動的にスレーブに切り替え
- **ロードバランサー**: 複数のバックエンドインスタンス間で自動負荷分散
- **ヘルスチェック**: 定期的なヘルスチェックによる自動障害検知

### 3. 監視とアラート
- **監視ツール**: Prometheus + Grafana によるメトリクス監視
- **ログ集約**: ELK Stack（Elasticsearch, Logstash, Kibana）によるログ分析
- **アラート通知**: PagerDuty、Slack による即座の通知

### 4. クラウドネイティブなバックアップ
- **マネージドバックアップ**: AWS RDS の自動バックアップ、Google Cloud SQL の自動バックアップ
- **オブジェクトストレージ**: S3 のバージョニングとライフサイクルポリシー
- **スナップショット**: 定期的なディスクスナップショット

## バックアップ・復旧チェックリスト

### 日常運用
- [ ] バックアップが正常に実行されているか確認（毎日）
- [ ] バックアップファイルのサイズと整合性を確認（毎週）
- [ ] バックアップ保存場所のディスク容量を確認（毎週）

### 定期メンテナンス
- [ ] 古いバックアップの削除（毎月）
- [ ] バックアップスクリプトの動作確認（毎月）
- [ ] 災害復旧訓練の実施（四半期ごと）

### 障害発生時
- [ ] 最新のバックアップファイルを確認
- [ ] 復旧手順書を参照
- [ ] 復旧作業を実行
- [ ] 動作確認とテスト
- [ ] 障害原因の調査と再発防止策の検討

