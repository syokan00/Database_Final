# システムアーキテクチャ

## 概要

本システムは、フロントエンド（React + Vite）、バックエンド（FastAPI）、データベース（PostgreSQL）、オブジェクトストレージ（MinIO）、キャッシュ（Redis）で構成される Web アプリケーションです。

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                        クライアント層                          │
│                    (Web ブラウザ / モバイル)                   │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTPS
                           │
┌──────────────────────────▼──────────────────────────────────┐
│                     フロントエンド層                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  GitHub Pages (静的ホスティング)                        │  │
│  │  - React (SPA)                                        │  │
│  │  - Vite (ビルドツール)                                 │  │
│  │  - React Router (HashRouter)                          │  │
│  │  - Axios (HTTP クライアント)                           │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │ REST API (JSON)
                           │
┌──────────────────────────▼──────────────────────────────────┐
│                     バックエンド層                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  FastAPI (Python)                                     │  │
│  │  - RESTful API                                        │  │
│  │  - JWT 認証                                           │  │
│  │  - SQLAlchemy ORM                                     │  │
│  │  - CORS 設定                                          │  │
│  │  - レート制限 (Redis)                                  │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────┬──────────────────────────────┬──────────────────┘
           │                              │
           │                              │
┌──────────▼──────────┐    ┌─────────────▼──────────────┐
│   データベース層       │    │   オブジェクトストレージ層    │
│  ┌────────────────┐  │    │  ┌──────────────────────┐  │
│  │  PostgreSQL    │  │    │  │  MinIO               │  │
│  │  - ユーザー情報  │  │    │  │  - 画像ファイル       │  │
│  │  - 投稿データ    │  │    │  │  - 添付ファイル       │  │
│  │  - 出品アイテム  │  │    │  │  - 一時ファイル       │  │
│  │  - いいね情報    │  │    │  └──────────────────────┘  │
│  └────────────────┘  │    └──────────────────────────────┘
└──────────────────────┘
           │
           │
┌──────────▼──────────┐
│   キャッシュ層        │
│  ┌────────────────┐  │
│  │  Redis         │  │
│  │  - セッション    │  │
│  │  - レート制限    │  │
│  │  - 一時データ    │  │
│  └────────────────┘  │
└──────────────────────┘
```

## 各層の説明

### 1. クライアント層
- **役割**: ユーザーインターフェースの表示と操作
- **技術**: モダンな Web ブラウザ（Chrome, Firefox, Safari, Edge など）
- **通信**: HTTPS プロトコルを使用

### 2. フロントエンド層
- **役割**: ユーザーインターフェースの実装と API 呼び出し
- **技術スタック**:
  - React: UI コンポーネントライブラリ
  - Vite: 高速ビルドツール
  - React Router (HashRouter): クライアントサイドルーティング
  - Axios: HTTP リクエスト
  - Context API: 状態管理（認証、言語、投稿データ）
- **デプロイ**: GitHub Pages（静的ホスティング）
- **特徴**: SPA（Single Page Application）として動作

### 3. バックエンド層
- **役割**: ビジネスロジックの実装と API 提供
- **技術スタック**:
  - FastAPI: モダンな Python Web フレームワーク
  - SQLAlchemy: ORM（Object-Relational Mapping）
  - JWT: 認証トークン
  - Pydantic: データバリデーション
  - Redis: レート制限用キャッシュ
- **主要機能**:
  - ユーザー認証・認可
  - CRUD 操作（投稿、出品アイテム）
  - ファイルアップロード処理
  - レート制限

### 4. データベース層
- **役割**: 永続的なデータの保存
- **技術**: PostgreSQL（リレーショナルデータベース）
- **主要テーブル**:
  - `users`: ユーザー情報
  - `posts`: 投稿データ
  - `items`: 出品アイテム
  - `likes`: いいね情報
- **特徴**: ACID トランザクション、外部キー制約、インデックス最適化

### 5. オブジェクトストレージ層
- **役割**: 画像やファイルなどのバイナリデータの保存
- **技術**: MinIO（S3 互換オブジェクトストレージ）
- **保存データ**:
  - ユーザーアバター画像
  - 投稿・出品アイテムの画像
  - 添付ファイル
- **特徴**: スケーラブル、高可用性

### 6. キャッシュ層
- **役割**: 一時データの高速アクセス
- **技術**: Redis（インメモリデータストア）
- **用途**:
  - レート制限のカウンター
  - セッション情報（オプション）
  - 一時的なキャッシュデータ

## データフロー

1. **ユーザーリクエスト**: ブラウザからフロントエンド（GitHub Pages）へ
2. **API 呼び出し**: フロントエンドからバックエンド（FastAPI）へ REST API リクエスト
3. **データ取得**: バックエンドが PostgreSQL からデータを取得
4. **ファイル取得**: 必要に応じて MinIO から画像・ファイルを取得
5. **レスポンス**: バックエンドからフロントエンドへ JSON レスポンス
6. **表示更新**: フロントエンドが UI を更新

## セキュリティ対策

- **HTTPS**: 通信の暗号化
- **JWT 認証**: トークンベースの認証
- **CORS**: クロスオリジンリクエストの制限
- **レート制限**: Redis を使用した API 呼び出し制限
- **パスワードハッシュ**: Argon2 を使用した安全なパスワード保存
- **SQL インジェクション対策**: SQLAlchemy ORM によるパラメータ化クエリ

## デプロイメント構成

### 開発環境
- フロントエンド: `npm run dev`（ローカル開発サーバー）
- バックエンド: Docker Compose（PostgreSQL, MinIO, Redis を含む）
- データベース: Docker コンテナ内の PostgreSQL

### 本番環境（展示用）
- フロントエンド: GitHub Pages（静的ホスティング）
- バックエンド: ローカル Docker（開発用）
- データベース: Docker コンテナ内の PostgreSQL

### 将来の本番環境（理想）
- フロントエンド: CDN（Cloudflare, AWS CloudFront など）
- バックエンド: クラウドサーバー（AWS EC2, Google Cloud Run など）
- データベース: マネージド PostgreSQL（AWS RDS, Google Cloud SQL など）
- オブジェクトストレージ: マネージド S3（AWS S3, Google Cloud Storage など）
- キャッシュ: マネージド Redis（AWS ElastiCache, Google Cloud Memorystore など）

## 拡張性

- **水平スケーリング**: バックエンドを複数インスタンスで実行可能
- **ロードバランサー**: 複数のバックエンドインスタンス間で負荷分散
- **データベースレプリケーション**: 読み取り専用レプリカで読み取り負荷を分散
- **CDN**: 静的ファイル（画像など）を CDN で配信して高速化

